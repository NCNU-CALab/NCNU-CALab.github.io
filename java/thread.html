<!DOCTYPE html>
<html lang="zh">
  <head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">

    <title>SSYU 的書們 | 線串與同步處理 </title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <!-- fonts -->
    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Ubuntu:300,400,500,600,700" rel="stylesheet">

    <!-- stylesheets -->
    <link rel="stylesheet" href="/style/doc.css">

    <!-- favicon -->
    <link rel="icon" href="/images/favicon.ico"><!-- hexo-inject:begin --><!-- hexo-inject:end -->

    

  </head>
  <body>

   <!-- hexo-inject:begin --><!-- hexo-inject:end --><script>window.__INITIAL_STATE__ = {"page":{"title":"線串與同步處理","path":"java/thread.html"},"data":{"navigation":{"logo":{"text":"Programming Yu","type":"link","path":"index.html"},"main":[{"text":"C 程式語言教學","type":"label","children":[{"text":"程式寫作概論","type":"link","path":"c/writing-intro.html"},{"text":"電腦系統概論","type":"link","path":"c/system-intro.html"},{"text":"電腦內部運作","type":"link","path":"c/system-operation.html"},{"text":"C 語言的總覽","type":"link","path":"c/c-intro.html"}]},{"text":"C 程式語言範例","type":"label","children":[{}]},{"text":"Java 程式語言教學","type":"label","children":[{"text":"Java 與 C 的比較","type":"link","path":"java/java-vs-c.html"},{"text":"類別與物件","type":"link","path":"java/class-and-obj.html"},{"text":"陣列","type":"link","path":"java/array.html"},{"text":"封裝","type":"link","path":"java/encapsulation.html"},{"text":"訊息傳遞","type":"link","path":"java/message-passing.html"},{"text":"繼承","type":"link","path":"java/extends.html"},{"text":"介面","type":"link","path":"java/interface.html"},{"text":"例外處理","type":"link","path":"java/exception.html"},{"text":"線串與同步處理","type":"link","path":"java/thread.html"},{"text":"容器類別","type":"link","path":"java/container.html"},{"text":"GUI","type":"link","path":"java/gui.html"},{"text":"IO","type":"link","path":"java/io.html"},{"text":"NET","type":"link","path":"java/net.html"},{"text":"JDBC","type":"link","path":"java/jdbc.html"},{"text":"印表","type":"link","path":"java/easy-print.html"}]},{"text":"Java 程式語言範例","type":"label","children":[{"text":"所得稅計算","type":"link","path":"java/examples/tax-calculate.html"}]},{"text":"資料結構與演算法","type":"label"}]},"posts":[{"text":"The 3n + 1 problem","type":"link","path":"questions/The-3n-1-problem/","date":"2017-12-21T19:53:25+00:00"}]},"config":{"timezone":"Asia/Taipei","root":"/","time_format":"HH:mm:ss","theme":"doc","theme_config":{"swagger_ui":{"version":2,"permalinks":true,"api_explorer":true,"download":"Download specification","show_extensions":false,"deep_linking":true,"display_operation_id":false,"doc_expansion":"none"},"search":{"skip":false,"background":false,"route":"/lunr.json"},"favicon":"images/favicon.ico"}}}</script>

    <div id="react-navigation-root"><div class="doc-navigation" data-reactroot=""><nav class="doc-navbar"><a href="/index.html" class="doc-navbar__logo"><img src="/images/logo.png" class="doc-navbar__logo__img"/><span class="doc-navbar__logo__text">Programming Yu</span></a><i class="dc-icon dc-icon--close dc-icon--interactive doc-sidebar-close doc-navbar__sidebar-close doc-navbar__sidebar-close--desktop"></i><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-navbar__sidebar-toggle"></i></nav><nav class="doc-sidebar"><div class="doc-sidebar__vertical-menu"><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-sidebar-toggle--primary doc-sidebar__vertical-menu__item"></i><i class="dc-icon dc-icon--search dc-icon--interactive doc-sidebar__vertical-menu__item doc-sidebar__vertical-menu__item--primary"></i></div><div class="doc-sidebar-content"><div class="doc-sidebar__search-form"></div><ul class="doc-sidebar-list"></ul></div></nav></div></div>
    <div class="doc-content">
  <div class="dc-page">
    <div class="dc-card">
      <div id="react-search-results-root"></div>
      <div id="page-content" class="doc-formatting">
        <h1>線串與同步處理</h1>
        <h2 id="Program-Process-Thread"><a href="#Program-Process-Thread" class="headerlink" title="Program, Process, Thread"></a>Program, Process, Thread</h2><p>在介紹 Thread 之前，我們必須先把 Program 和 Process 這兩個觀念作一個釐清。</p>
<ul>
<li>Program：一群程式碼的集合，用以解決特定的問題。以物件導向的觀念來類比，相當於 Class。</li>
<li>Process：由 Program 所產生的執行個體，一個 Program 可以同時執行多次，產生多個Process。以物件導向的觀念來類比，相當於 Object。<br>每一個 Process 又由以下兩個東西組成<ul>
<li>一個 Memory Space：相當於 Object 的 variable，不同 Process 的 Memory Space 也不同，彼此看不到對方的 Memory Space。</li>
<li>一個或以上的 Thread：Thread 代表從某個起始點開始(例如 <code>main</code>)，到目前為止所有函數的呼叫路徑，以及這些呼叫路徑上所用到的區域變數。當然程式的執行狀態，除了紀錄在主記憶體外，CPU 內部的暫存器(如 <code>Program Counter</code>、<code>Stack Pointer</code>、<code>Program Status Word</code> 等)也需要一起紀錄。<br>所以 Thread 又由下面兩項組成<ul>
<li>Stack：紀錄函數呼叫路徑，以及這些函數所用到的區域變數</li>
<li>目前 CPU 的狀態</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>由上面的描述中，我們在歸納 Thread 的重點如下</p>
<ul>
<li>一個 Process 可以有多個 Thread。</li>
<li>同一個 Process 內的 Thread 使用相同的 Memory Space，但這些 Thread 各自擁有其 Stack。換句話說，Thread 能透過 reference 存取到相同的 Object，但是 local variable 卻是各自獨立的。</li>
<li>作業系統會根據 Thread 的優先權以及已經用掉的 CPU 時間，在不同的 Thread 作切換，以讓各個 Thread 都有機會執行。</li>
</ul>
<h2 id="如何產生-Thread"><a href="#如何產生-Thread" class="headerlink" title="如何產生 Thread"></a>如何產生 Thread</h2><p>Java 以 <code>java.lang.Thread</code> 這個類別來表示 Thread。</p>
<p>Class Thread 有兩個 Constructor：</p>
<ol>
<li><code>Thread()</code></li>
<li><code>Thread(Runnable)</code></li>
</ol>
<p>第一個 Constrctor 沒有參數，第二個需要一個 Runnable 物件當參數。</p>
<p>Runnable 是一個 interface，定義於 <code>java.lang</code> 內，其宣告為</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>Thread()</code> 產生的 Thread，其進入點為 Thread 裡的 <code>run()</code>；使用 <code>Thread(Runnable)</code> 產生的 Thread，其進入點為 Runnable 物件裡的 <code>run()</code>。</p>
<p>當 <code>run()</code> 結束時，這個 Thread 也就結束了；這和 <code>main()</code> 結束有相同的效果。其用法以下面範例說明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadExample1</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; <span class="comment">// override Thread's run()</span></span><br><span class="line">        System.out.println(<span class="string">"Here is the starting point of Thread."</span>);</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123; <span class="comment">// infinite loop to print message</span></span><br><span class="line">            System.out.println(<span class="string">"User Created Thread"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> </span>&#123;</span><br><span class="line">        Thread t = <span class="keyword">new</span> ThreadExample1(); <span class="comment">// 產生Thread物件</span></span><br><span class="line">        t.start(); <span class="comment">// 開始執行t.run()</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Main Thread"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上程式執行後，螢幕上會持續印出 <code>User Created Thread</code> 或 <code>Main Thread</code> 的字樣。</p>
<p>利用 Runnable 的寫法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadExample2</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; <span class="comment">// implements Runnable run()</span></span><br><span class="line">        System.out.println(<span class="string">"Here is the starting point of Thread."</span>);</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123; <span class="comment">// infinite loop to print message</span></span><br><span class="line">            System.out.println(<span class="string">"User Created Thread"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> </span>&#123;</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ThreadExample2()); <span class="comment">// 產生Thread物件</span></span><br><span class="line">        t.start(); <span class="comment">// 開始執行Runnable.run();</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Main Thread"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Thread-的優先權與影響資源的相關方法"><a href="#Thread-的優先權與影響資源的相關方法" class="headerlink" title="Thread 的優先權與影響資源的相關方法"></a>Thread 的優先權與影響資源的相關方法</h2><p><code>Thread.setPriority(int)</code> 可以設定 Thread 的優先權，數字越大優先權越高。</p>
<p>Thread 定義了 3 個相關的 static final variable：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_PRIORITY <span class="number">10</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_PRIORITY <span class="number">1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NORM_PRIORITY <span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>要提醒讀者的是，優先權高的 Thread 其佔有 CPU 的機會比較高，但優先權低的也都會有機會執行到。其他有關 Thread 執行的方法有：</p>
<ul>
<li><code>yield()</code>：先讓給別的 Thread 執行</li>
<li><code>sleep(int time)</code>：休息 time mini second (1/1000秒)</li>
<li><code>join()</code>：呼叫 <code>ThreadA.join()</code> 的執行緒會等到 ThreadA 結束後，才能繼續執行</li>
</ul>
<p>你可以執行下面的程式，看看 <code>yield()</code> 的效果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadExample1</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; <span class="comment">// overwrite Thread's run()</span></span><br><span class="line">        System.out.println(<span class="string">"Here is the starting point of Thread."</span>);</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123; <span class="comment">// infinite loop to print message</span></span><br><span class="line">            System.out.println(<span class="string">"User Created Thread"</span>);</span><br><span class="line">            yield();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> </span>&#123;</span><br><span class="line">        Thread t = <span class="keyword">new</span> ThreadExample1(); <span class="comment">// 產生Thread物件</span></span><br><span class="line">        t.start(); <span class="comment">// 開始執行t.run()</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Main Thread"</span>);</span><br><span class="line">            yield();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>觀看 <code>join()</code> 的效果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinExample</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    String myId;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JoinExample</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        myId = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; <span class="comment">// overwrite Thread's run()</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; <span class="number">500</span>; i++) &#123;</span><br><span class="line">            System.out.println(myId+<span class="string">" Thread"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> JoinExample(<span class="string">"T1"</span>); <span class="comment">// 產生Thread物件</span></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> JoinExample(<span class="string">"T2"</span>); <span class="comment">// 產生Thread物件</span></span><br><span class="line">        t1.start(); <span class="comment">// 開始執行t1.run()</span></span><br><span class="line">        t2.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t1.join(); <span class="comment">// 等待t1結束</span></span><br><span class="line">            t2.join(); <span class="comment">// 等待t2結束</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Main Thread"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>觀看 <code>sleep()</code> 的效果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SleepExample</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    String myId;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SleepExample</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        myId = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; <span class="comment">// overwrite Thread's run()</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; <span class="number">500</span>; i++) &#123;</span><br><span class="line">            System.out.println(myId+<span class="string">" Thread"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> SleepExample(<span class="string">"T1"</span>); <span class="comment">// 產生Thread物件</span></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> SleepExample(<span class="string">"T2"</span>); <span class="comment">// 產生Thread物件</span></span><br><span class="line">        t1.start(); <span class="comment">// 開始執行t1.run()</span></span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Critical-Section-關鍵時刻-的保護措施"><a href="#Critical-Section-關鍵時刻-的保護措施" class="headerlink" title="Critical Section (關鍵時刻) 的保護措施"></a>Critical Section (關鍵時刻) 的保護措施</h2><p>如果設計者沒有提供保護機制的話，Thread 取得和失去 CPU 控制權的時機是由作業系統來決定。</p>
<p>也就是說 Thread 可能在執行任何一個機器指令時，被作業系統取走 CPU 控制權，並交給另一個 Thread。</p>
<p>由於某些真實世界的動作是不可分割的，例如跨行轉帳 X 元由 A 帳戶到 B 帳戶，轉帳前後這兩個帳戶的總金額必須相同，但以程式來實作時，卻無法用一個指令就完成，如轉帳可能要寫成下面的這一段程式碼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (A &gt;= X) &#123;</span><br><span class="line">    A = A - X; // 翻譯成3個機器指令LOAD A, SUB X, STORE A</span><br><span class="line">    B = B + X;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果兩個 Thread 同時要存取 A、B 兩帳戶進行轉帳，假設當 Thread 1 執行到 SUBX 後被中斷，Thread 2 接手執行完成另一個轉帳要求，然後 Thread 1 繼續執行未完成的動作，請問這兩個轉帳動作正確嗎？</p>
<p>我們以 A = 1000、B = 0 分別轉帳 100、200 元來說明此結果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LOAD A // Thread 1 現在 A 還是 1000</span><br><span class="line">SUB 100 // Thread 1</span><br><span class="line">LOAD A // 假設此時 Thread 1 被中斷，Thread 2 接手，因為 Thread 1 還沒有執行 STORE A，所以變數 A 還是 1000</span><br><span class="line">SUB 200 // Thread 2</span><br><span class="line">STORE A // Thread 2，A = 800</span><br><span class="line">LOAD B // Thread 2，B 現在是 0</span><br><span class="line">ADD 200 // Thread 2</span><br><span class="line">STORE B // B = 200</span><br><span class="line">STORE A // Thread 1 拿回控制權，A = 900</span><br><span class="line">LOAD B // Thread 1，B = 200</span><br><span class="line">ADD 100 // Thread 1</span><br><span class="line">STORE B // B = 300</span><br></pre></td></tr></table></figure>
<p>你會發現執行完成後 A = 900、B = 300，也就是說銀行平白損失了 200 元，當然另外的執行順序可能造成其他不正確的結果。</p>
<p>我們把這問題再整理一下：</p>
<ol>
<li>寫程式時假設指令會循序執行</li>
<li>某些不可分割的動作，需要以多個機器指令來完成</li>
<li>Thread 執行時可能在某個機器指令被中斷</li>
<li>兩個 Thread 可能執行同一段程式碼，存取同一個資料結構</li>
<li>這樣就破壞了第 1 點的假設</li>
</ol>
<p>因此在撰寫多執行緒的程式時，必須特別考慮這種狀況(又稱為 race condition)。</p>
<p>Java 的解決辦法是，JVM 會在每個物件上擺一把鎖(lock)，然後程式設計者可以宣告執行某一段程式(通常是用來存取共同資料結構的程式碼，又稱為 Critical Section)時，必須拿到某物件的鎖才行，這個鎖同時間最多只有一個執行緒可以擁有它。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Transfer</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> A = <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> B = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> amount;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Transfer</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        amount = x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(lock) &#123; <span class="comment">// 取得lock,如果別的thread A已取得,則目前這個thread會等到thread A釋放該lock</span></span><br><span class="line">            <span class="keyword">if</span> (A &gt;= amount) &#123;</span><br><span class="line">                A = A - amount;</span><br><span class="line">                B = B + amount;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="comment">// 離開synchronized區塊後,此thread會自動釋放lock</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Transfer(<span class="number">100</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Transfer(<span class="number">200</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除了 synchronized(ref) 的語法可以鎖定 ref 指到的物件外，synchronized 也可以用在 object method 前面，表示要鎖定 this 物件才能執行該方法。</p>
<p>以下是 Queue 結構的範例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Queue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object[] data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> head;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> tail;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Queue</span><span class="params">(<span class="keyword">int</span> maxLen)</span> </span>&#123;</span><br><span class="line">        data = <span class="keyword">new</span> Object[maxLen];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Object <span class="title">deQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object tmp = data[head];</span><br><span class="line">        data[head] = <span class="keyword">null</span>;</span><br><span class="line">        head = (head+<span class="number">1</span>)%data.length;</span><br><span class="line">        size--;</span><br><span class="line">        <span class="keyword">return</span> tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enQueue</span><span class="params">(Object c)</span> </span>&#123;</span><br><span class="line">        data[tail++] = c;</span><br><span class="line">        tail %= data.length;</span><br><span class="line">        size++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>雖然上面的程式正確無誤，但並未考慮資源不足時該如何處理。</p>
<p>例如 Queue 已經沒有資料了，卻還想拿出來；或是 Queue 裡已經塞滿了資料，使用者卻還要放進去？</p>
<p>我們當然可以使用 Exception Handling 的機制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Queue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object[] data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> head;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> tail;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Queue</span><span class="params">(<span class="keyword">int</span> maxLen)</span> </span>&#123;</span><br><span class="line">        data = <span class="keyword">new</span> Object[maxLen];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Object <span class="title">deQueue</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">        &#125;</span><br><span class="line">        Object tmp = data[head];</span><br><span class="line">        data[head] = <span class="keyword">null</span>;</span><br><span class="line">        head = (head+<span class="number">1</span>)%data.length;</span><br><span class="line">        size--;</span><br><span class="line">        <span class="keyword">return</span> tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enQueue</span><span class="params">(Object c)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (size &gt;= maxLen) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">        &#125;</span><br><span class="line">        data[tail++] = c;</span><br><span class="line">        tail %= data.length;</span><br><span class="line">        size++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但假設我們的執行環境是，某些 Thread 專門負責讀取使用者的需求，並把工作放到 Queue 裡面，某些 Thread 則專門由 Queue 裡抓取工作需求做進一步處理。</p>
<p>這種架構的好處是，可以把慢速或不定速的輸入(如透過網路讀資料，連線速度可能差很多)和快速的處理分開，可使系統的反應速度更快，更節省資源。</p>
<p>那麼以 Exceptoin 來處理 Queue 空掉或爆掉的情況並不合適，因為使用 Queue 的人必須處理例外狀況，並不斷的消耗CPU資源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Getter</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    Queue q;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Getter</span><span class="params">(Queue q)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.q = q;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object data = q.deQueue();</span><br><span class="line">                <span class="comment">// processing</span></span><br><span class="line">            &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">                <span class="comment">// if we try to sleep here, user may feel slow response</span></span><br><span class="line">                <span class="comment">// if we do not sleep, CPU will be wasted</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Putter</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    Queue q;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Putter</span><span class="params">(Queue q)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.q = q;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object data = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">// get user request</span></span><br><span class="line">                 q.enQueue(data);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">                <span class="comment">// if we try to sleep here, user may feel slow response</span></span><br><span class="line">                <span class="comment">// if we do not sleep, CPU will be wasted</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> </span>&#123;</span><br><span class="line">        Queue q = <span class="keyword">new</span> Queue(<span class="number">10</span>);</span><br><span class="line">        Getter r1 = <span class="keyword">new</span> Getter(q);</span><br><span class="line">        Getter r2 = <span class="keyword">new</span> Getter(q);</span><br><span class="line">        Putter w1 = <span class="keyword">new</span> Putter(q);</span><br><span class="line">        Putter w2 = <span class="keyword">new</span> Putter(q);</span><br><span class="line">        r1.start();</span><br><span class="line">        r2.start();</span><br><span class="line">        w1.start();</span><br><span class="line">        w2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>為了解決這類資源分配的問題，Java Object 提供了下面三個 method：</p>
<ul>
<li><code>wait()</code>：使呼叫此方法的 Thread 進入 Blocking Mode，並設為等待該 Object，呼叫 <code>wait()</code> 時，該 Thread 必須擁有該物件的 lock。Blocking Mode 下的 Thread 必須釋放所有手中的 lock，並且無法使用CPU。</li>
<li><code>notifyAll()</code>：讓等待該 Object 的所有 Thread 進入 Runnable Mode。</li>
<li><code>notify()</code>：讓等待該 Object 的某一個 Thread 進入 Runnable Mode。</li>
</ul>
<p>所謂 Runnable Mode 是指該 Thread 隨時可由作業系統分配CPU資源。</p>
<p>Blocking Mode 表示該 Thread 正在等待某個事件發生，作業系統不會讓這種 Thread 取得 CPU 資源。</p>
<p>前一個 Queue 的範例就可以寫成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Queue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object[] data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> head;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> tail;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Queue</span><span class="params">(<span class="keyword">int</span> maxLen)</span> </span>&#123;</span><br><span class="line">        data = <span class="keyword">new</span> Object[maxLen];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Object <span class="title">deQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (size==<span class="number">0</span>) &#123; <span class="comment">// When executing here, Thread must have got lock and be in running mode</span></span><br><span class="line">            <span class="comment">// Let current Thread wait this object(to sleeping mode)</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                wait(); <span class="comment">// to sleeping mode, and release all lock</span></span><br><span class="line">            &#125; <span class="keyword">catch</span>(Exception ex) &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        Object tmp = data[head];</span><br><span class="line">        data[head] = <span class="keyword">null</span>;</span><br><span class="line">        head = (head+<span class="number">1</span>)%data.length;</span><br><span class="line">        <span class="keyword">if</span> (size==data.length) &#123;</span><br><span class="line">            <span class="comment">// wake up all Threads waiting this object</span></span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">        size--;</span><br><span class="line">        <span class="keyword">return</span> tmp;</span><br><span class="line">    &#125; <span class="comment">// release lock</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enQueue</span><span class="params">(Object c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (size==data.length) &#123;  <span class="comment">// When executing here, Thread must have got lock and be in running mode</span></span><br><span class="line">            <span class="comment">// Let current thread wait this object(to sleeping mode)</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                wait(); <span class="comment">// to sleeping mode, and release all lock</span></span><br><span class="line">            &#125; <span class="keyword">catch</span>(Exception ex) &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        data[tail++] = c;</span><br><span class="line">        tail %= data.length;</span><br><span class="line">        size++;</span><br><span class="line">        <span class="keyword">if</span> (size==<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// wake up all Threads waiting this object</span></span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReaderWriter</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> READER = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WRITER = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> Queue q;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mode;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mode==READER) &#123;</span><br><span class="line">                q.deQueue();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode==WRITER) &#123;</span><br><span class="line">                q.enQueue(<span class="keyword">new</span> Integer(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReaderWriter</span><span class="params">(Queue q, <span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.q = q;</span><br><span class="line">        <span class="keyword">this</span>.mode = mode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Queue q = <span class="keyword">new</span> Queue(<span class="number">5</span>);</span><br><span class="line">        ReaderWriter r1, r2, w1, w2;</span><br><span class="line">        (w1 = <span class="keyword">new</span> ReaderWriter(q, WRITER)).start();</span><br><span class="line">        (w2 = <span class="keyword">new</span> ReaderWriter(q, WRITER)).start();</span><br><span class="line">        (r1 = <span class="keyword">new</span> ReaderWriter(q, READER)).start();</span><br><span class="line">        (r2 = <span class="keyword">new</span> ReaderWriter(q, READER)).start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            w1.join(); <span class="comment">// wait until w1 complete</span></span><br><span class="line">            w2.join(); <span class="comment">// wait until w2 complete</span></span><br><span class="line">            r1.join(); <span class="comment">// wait until r1 complete</span></span><br><span class="line">            r2.join(); <span class="comment">// wait until r2 complete</span></span><br><span class="line">        &#125; <span class="keyword">catch</span>(InterruptedException epp) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Multiple-Reader-Writer-Monitors"><a href="#Multiple-Reader-Writer-Monitors" class="headerlink" title="Multiple Reader-Writer Monitors"></a>Multiple Reader-Writer Monitors</h2><p>上一節的 Queue 資料結構，不論是 <code>enQueue()</code> 或 <code>deQueue()</code> 都會更動到 Queue 的內容。而在許多應用裡，資料結構可以允許同時多個讀一個寫。</p>
<p>本節舉出幾個不同的例子，說明多個 Reader-Writer 時的可能排程法。</p>
<h3 id="Single-Reader-Writer：只同時允許一個執行緒存取"><a href="#Single-Reader-Writer：只同時允許一個執行緒存取" class="headerlink" title="Single Reader-Writer：只同時允許一個執行緒存取"></a>Single Reader-Writer：只同時允許一個執行緒存取</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleReaderWriter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n; <span class="comment">// number of reader and write, 0 or 1</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startReading</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (n != <span class="number">0</span>) &#123;</span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        n = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stopReading</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        n = <span class="number">0</span>;</span><br><span class="line">        notify();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startWriting</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (n != <span class="number">0</span>) &#123;</span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        n = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stopWriting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        n = <span class="number">0</span>;</span><br><span class="line">        notify();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 這是一個使用範例, 程式能否正確執行要靠呼叫正確的start和stop</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WriterThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    SingleReaderWriter srw;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WriterThread</span><span class="params">(SingleReaderWriter srw)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.srw = srw;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        startWring();</span><br><span class="line">        <span class="comment">// insert real job here</span></span><br><span class="line">        stopWriting();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReaderThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    SingleReaderWriter srw;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReaderThread</span><span class="params">(SingleReaderWriter srw)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.srw = srw;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        startReading();</span><br><span class="line">        <span class="comment">// insert real job here</span></span><br><span class="line">        stopReading();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> </span>&#123;</span><br><span class="line">        SingleReaderWriter srw = <span class="keyword">new</span> SingleReaderWriter;</span><br><span class="line">        <span class="comment">// create four threads</span></span><br><span class="line">        (<span class="keyword">new</span> WriterThread(srw)).start();</span><br><span class="line">        (<span class="keyword">new</span> WriterThread(srw)).start();</span><br><span class="line">        (<span class="keyword">new</span> ReaderThread(srw)).start();</span><br><span class="line">        (<span class="keyword">new</span> ReaderThread(srw)).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Reader-優先"><a href="#Reader-優先" class="headerlink" title="Reader 優先"></a>Reader 優先</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadersPreferredMonitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> nr; <span class="comment">// The number of threads currently reading, nr &gt; = 0</span></span><br><span class="line">    <span class="keyword">int</span> nw; <span class="comment">// The number of threads currently writing, 0 or 1</span></span><br><span class="line">    <span class="keyword">int</span> nrtotal; <span class="comment">// The number of threads either reading or waiting to read, nrtotal &gt; = nr</span></span><br><span class="line">    <span class="keyword">int</span> nwtotal; <span class="comment">// The number of threads either writing or waiting to write</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startReading</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        nrtotal++; <span class="comment">// 想要read的thread又多了一個</span></span><br><span class="line">        <span class="keyword">while</span> (nw != <span class="number">0</span>) &#123; <span class="comment">// 還有write thread正在write</span></span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        nr++; <span class="comment">// 正在讀的thread多了一個</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startWriting</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        nwtotal++; <span class="comment">// 想要寫的thread又多了一個</span></span><br><span class="line">        <span class="keyword">while</span> (nrtotal+nw != <span class="number">0</span>) &#123; <span class="comment">// 只要有thread想要讀,或是有thread正在寫,禮讓</span></span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        nw = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stopReading</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        nr--; <span class="comment">// 正在讀的少一個</span></span><br><span class="line">        nrtotal--; <span class="comment">// 想要讀的少一個</span></span><br><span class="line">        <span class="keyword">if</span> (nrtotal == <span class="number">0</span>) &#123; <span class="comment">// 如果沒有要讀的,叫醒想寫的</span></span><br><span class="line">            notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stopWriting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        nw = <span class="number">0</span>; <span class="comment">// 沒有thread正在寫</span></span><br><span class="line">        nwtotal--; <span class="comment">// 想寫的少一個</span></span><br><span class="line">        notifyAll(); <span class="comment">// 叫醒所有想讀和想寫的</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Writer-優先"><a href="#Writer-優先" class="headerlink" title="Writer 優先"></a>Writer 優先</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WritersPreferredMonitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> nr; <span class="comment">// The number of threads currently reading, nr &gt; = 0</span></span><br><span class="line">    <span class="keyword">int</span> nw; <span class="comment">// The number of threads currently writing, 0 or 1</span></span><br><span class="line">    <span class="keyword">int</span> nrtotal; <span class="comment">// The number of threads either reading or waiting to read, nrtotal &gt; = nr</span></span><br><span class="line">    <span class="keyword">int</span> nwtotal; <span class="comment">// The number of threads either writing or waiting to write</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startReading</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        nrtotal++; <span class="comment">// 想要read的thread又多了一個</span></span><br><span class="line">        <span class="keyword">while</span> (nwtotal != <span class="number">0</span>) &#123; <span class="comment">// 還有thread想要write</span></span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        nr++; <span class="comment">// 正在讀的thread多了一個</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startWriting</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        nwtotal++; <span class="comment">// 想要寫的thread又多了一個</span></span><br><span class="line">        <span class="keyword">while</span> (nr+nw != <span class="number">0</span>) &#123; <span class="comment">// 有thread正在讀,或是有thread正在寫</span></span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        nw = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stopReading</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        nr--; <span class="comment">// 正在讀的少一個</span></span><br><span class="line">        nrtotal--; <span class="comment">// 想要讀的少一個</span></span><br><span class="line">        <span class="keyword">if</span> (nr == <span class="number">0</span>) &#123; <span class="comment">// 如果沒有正在讀的,叫醒所有的(包括想寫的)</span></span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stopWriting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        nw = <span class="number">0</span>; <span class="comment">// 沒有thread正在寫</span></span><br><span class="line">        nwtotal--; <span class="comment">// 想寫的少一個</span></span><br><span class="line">        notifyAll(); <span class="comment">// 叫醒所有想讀和想寫的</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Reader-和-Writer-交互執行"><a href="#Reader-和-Writer-交互執行" class="headerlink" title="Reader 和 Writer 交互執行"></a>Reader 和 Writer 交互執行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlternatingReadersWritersMonitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] nr = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>]; <span class="comment">// The number of threads currently reading</span></span><br><span class="line">    <span class="keyword">int</span> thisBatch; <span class="comment">// Index in nr of the batch of readers currently reading(0 or 1)</span></span><br><span class="line">    <span class="keyword">int</span> nextBatch = <span class="number">1</span>; <span class="comment">// Index in nr of the batch of readers waitin to read(always 1-thisBatch)</span></span><br><span class="line">    <span class="keyword">int</span> nw; <span class="comment">// The number of threads currently writing(0 or 1)</span></span><br><span class="line">    <span class="keyword">int</span> nwtotal; <span class="comment">// The number of threads either writing or waiting to write</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startReading</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (nwtotal == <span class="number">0</span>) &#123; <span class="comment">// 沒有thread要write, 將reader都放到目前要處理的這一批</span></span><br><span class="line">            nr[thisBatch]++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nr[nextBatch]++;</span><br><span class="line">            <span class="keyword">int</span> myBatch = nextBatch;</span><br><span class="line">            <span class="keyword">while</span> (thisBatch != myBatch) &#123;</span><br><span class="line">                wait();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stopReading</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        nr[thisBatch]--;</span><br><span class="line">        <span class="keyword">if</span> (nr[thisBatch] == <span class="number">0</span>) &#123; <span class="comment">// 目前這批的reader都讀完了,找下一個writer</span></span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startWriting</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        nwtotal++;</span><br><span class="line">        <span class="keyword">while</span> (nr[thisBatch]+nw != <span class="number">0</span>) &#123; <span class="comment">// 目前這批還沒完,或有thread正在寫</span></span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        nw = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stopWriting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        nw = <span class="number">0</span>;</span><br><span class="line">        nwtotal--;</span><br><span class="line">        <span class="keyword">int</span> tmp = thisBatch; <span class="comment">// 交換下一批要讀的</span></span><br><span class="line">        thisBatch = nextBatch;</span><br><span class="line">        nextBatch = tmp;</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="給號依序執行"><a href="#給號依序執行" class="headerlink" title="給號依序執行"></a>給號依序執行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TakeANumberMonitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> nr; <span class="comment">// The number of threads currently reading</span></span><br><span class="line">    <span class="keyword">int</span> nextNumber; <span class="comment">// The number to be taken by the next thread to arrive</span></span><br><span class="line">    <span class="keyword">int</span> nowServing; <span class="comment">// The number of the thread to be served next</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startReading</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> myNumber = nextNumber++;</span><br><span class="line">        <span class="keyword">while</span> (nowServing != myNumber) &#123; <span class="comment">// 還沒輪到我</span></span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        nr++; <span class="comment">// 多了一個Reader</span></span><br><span class="line">        nowServing++; <span class="comment">// 準備檢查下一個</span></span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startWriting</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> myNumber = nextNumber++;</span><br><span class="line">        <span class="keyword">while</span> (nowServing != myNumber) &#123; <span class="comment">// 還沒輪到我</span></span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (nr &gt;  <span class="number">0</span>) &#123; <span class="comment">// 要等所有的Reader結束</span></span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stopReading</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        nr--; <span class="comment">// 少了一個Reader</span></span><br><span class="line">        <span class="keyword">if</span> (nr == <span class="number">0</span>) &#123;</span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">stopWriting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        nowServing++; <span class="comment">// 準備檢查下一個</span></span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        <div id="react-support-footer-root"></div>
      </div>
    </div>
  </div>
</div>

    


    

    <!-- js vendors -->
    <script src="//code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lunr.js/2.1.0/lunr.min.js"></script>

    <!-- js source  -->
    <script src="/script/doc.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

    

  </body>
</html>
